name: Simple Docker Deploy Pipeline

# Pipeline simplificado para desplegar solo la imagen Docker actualizada
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  AWS_DEFAULT_REGION: us-east-1
  ECR_REPOSITORY: amrize-ecr-repo
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # Job 1: Build and Push Docker Image to ECR
  docker_build_push:
    name: " Build & Deploy Docker Image"
    runs-on: ubuntu-latest
    
    outputs:
      image_uri: ${{ steps.build-image.outputs.image }}
      image_tag: ${{ steps.build-image.outputs.tag }}
      
    steps:
      - name:  Checkout Repository
        uses: actions/checkout@v4

      - name:  Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name:  Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name:  Get ECR Repository Info
        id: ecr-info
        run: |
          ECR_URI=$(aws ecr describe-repositories \
            --repository-names ${{ env.ECR_REPOSITORY }} \
            --region ${{ env.AWS_DEFAULT_REGION }} \
            --query 'repositories[0].repositoryUri' \
            --output text)
          echo " ECR Repository URI: $ECR_URI"
          echo "ecr_uri=$ECR_URI" >> $GITHUB_OUTPUT

      - name:  Build, Tag & Push Docker Image with Updated HTML
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          echo " Building Docker image with updated HTML content..."
          echo " HTML content will be copied from ./public-html/ to container"
          
          # Build image with commit SHA tag
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          
          # Tag as latest
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "⬆️ Pushing images to ECR..."
          
          # Push both tags
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo " Images pushed successfully!"
          echo " Image URI: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          
          # Set outputs
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name:  Cleanup Local Images
        run: |
          echo " Cleaning up local Docker images..."
          docker rmi $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG || true
          docker rmi $ECR_REGISTRY/$ECR_REPOSITORY:latest || true
          docker system prune -f

  # Job 2: Update ECS Service with New Image
  ecs_update:
    name: " Update ECS Service"
    runs-on: ubuntu-latest
    needs: docker_build_push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name:  Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name:  Install jq
        run: |
          echo " Installing jq for JSON manipulation..."
          sudo apt-get update && sudo apt-get install -y jq

      - name:  Check Current ECS Service Status
        run: |
          echo " Checking current ECS service status..."
          aws ecs describe-services \
            --cluster cluster-backend-holcim-images \
            --services ui \
            --query 'services[0].{Status:status,RunningCount:runningCount,DesiredCount:desiredCount,CurrentImage:taskDefinition}' \
            --output table

      - name: � Create New Task Definition with Updated Image
        run: |
          echo " Creating new task definition with image: ${{ needs.docker_build_push.outputs.image_uri }}"
          
          # Get current task definition
          CURRENT_TASK_DEF=$(aws ecs describe-services \
            --cluster cluster-backend-holcim-images \
            --services ui \
            --query 'services[0].taskDefinition' \
            --output text)
          
          echo "Current task definition: $CURRENT_TASK_DEF"
          
          # Get task definition details
          aws ecs describe-task-definition \
            --task-definition "$CURRENT_TASK_DEF" \
            --query 'taskDefinition' > current_task_def.json
          
          # Update the image in the container definition
          jq --arg image "${{ needs.docker_build_push.outputs.image_uri }}" \
             '.containerDefinitions[0].image = $image' \
             current_task_def.json > updated_task_def.json
          
          # Remove fields that shouldn't be in the new task definition
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .placementConstraints, .compatibilities, .registeredAt, .registeredBy)' \
             updated_task_def.json > new_task_def.json
          
          # Register new task definition
          NEW_TASK_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new_task_def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo " New task definition created: $NEW_TASK_ARN"
          echo "NEW_TASK_ARN=$NEW_TASK_ARN" >> $GITHUB_ENV

      - name:  Update ECS Service with New Task Definition
        run: |
          echo " Updating ECS service with new task definition: $NEW_TASK_ARN"
          
          # Update service with new task definition
          aws ecs update-service \
            --cluster cluster-backend-holcim-images \
            --service ui \
            --task-definition "$NEW_TASK_ARN" \
            --force-new-deployment

      - name:  Wait for Service Stability
        run: |
          echo " Waiting for ECS service to stabilize with new image..."
          aws ecs wait services-stable \
            --cluster cluster-backend-holcim-images \
            --services ui \
            --cli-read-timeout 90 \
            --cli-connect-timeout 60

      - name:  Verify Service Update
        run: |
          echo " Verifying service deployment..."
          aws ecs describe-services \
            --cluster cluster-backend-holcim-images \
            --services ui \
            --query 'services[0].{Status:status,RunningCount:runningCount,DesiredCount:desiredCount,TaskDefinition:taskDefinition}' \
            --output table

 